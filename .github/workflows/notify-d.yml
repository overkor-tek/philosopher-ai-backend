name: Notify D of Repository Activity

on:
  issues:
    types: [opened, closed, reopened]
  pull_request:
    types: [opened, closed, reopened, merged]
  release:
    types: [published, created]
  discussion:
    types: [created, answered]
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install nodemailer

      - name: Send notification email
        env:
          EMAIL_HOST: ${{ secrets.EMAIL_HOST }}
          EMAIL_PORT: ${{ secrets.EMAIL_PORT }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          RECIPIENT_EMAIL: darrick.preble@gmail.com
        run: |
          node -e "
          const nodemailer = require('nodemailer');
          
          const transporter = nodemailer.createTransport({
            host: process.env.EMAIL_HOST,
            port: process.env.EMAIL_PORT,
            auth: {
              user: process.env.EMAIL_USER,
              pass: process.env.EMAIL_PASS
            }
          });

          let subject = '';
          let message = '';
          const repo = '${{ github.repository }}';
          const actor = '${{ github.actor }}';
          const eventName = '${{ github.event_name }}';

          if (eventName === 'issues') {
            const action = '${{ github.event.action }}';
            const issueTitle = '${{ github.event.issue.title }}';
            const issueNumber = '${{ github.event.issue.number }}';
            const issueUrl = '${{ github.event.issue.html_url }}';
            
            subject = \`ðŸ’– Issue \${action}: #\${issueNumber} - \${issueTitle}\`;
            message = \`
              <h2>Issue \${action} in \${repo}</h2>
              <p><strong>Issue:</strong> #\${issueNumber} - \${issueTitle}</p>
              <p><strong>By:</strong> \${actor}</p>
              <p><strong>Action:</strong> \${action}</p>
              <p><a href=\"\${issueUrl}\" style=\"background:#FF69B4;color:#fff;padding:10px 20px;text-decoration:none;border-radius:5px;\">View Issue</a></p>
              <hr>
              <p style=\"color:#666;\">Part of The Pink Revolution ðŸ’–</p>
            \`;
          } else if (eventName === 'pull_request') {
            const action = '${{ github.event.action }}';
            const prTitle = '${{ github.event.pull_request.title }}';
            const prNumber = '${{ github.event.pull_request.number }}';
            const prUrl = '${{ github.event.pull_request.html_url }}';
            
            subject = \`ðŸ’– Pull Request \${action}: #\${prNumber} - \${prTitle}\`;
            message = \`
              <h2>Pull Request \${action} in \${repo}</h2>
              <p><strong>PR:</strong> #\${prNumber} - \${prTitle}</p>
              <p><strong>By:</strong> \${actor}</p>
              <p><strong>Action:</strong> \${action}</p>
              <p><a href=\"\${prUrl}\" style=\"background:#FF69B4;color:#fff;padding:10px 20px;text-decoration:none;border-radius:5px;\">View Pull Request</a></p>
              <hr>
              <p style=\"color:#666;\">Part of The Pink Revolution ðŸ’–</p>
            \`;
          } else if (eventName === 'release') {
            const releaseName = '${{ github.event.release.name }}';
            const releaseTag = '${{ github.event.release.tag_name }}';
            const releaseUrl = '${{ github.event.release.html_url }}';
            
            subject = \`ðŸš€ New Release: \${releaseName || releaseTag}\`;
            message = \`
              <h2>New Release Published in \${repo}</h2>
              <p><strong>Release:</strong> \${releaseName || releaseTag}</p>
              <p><strong>Tag:</strong> \${releaseTag}</p>
              <p><strong>By:</strong> \${actor}</p>
              <p><a href=\"\${releaseUrl}\" style=\"background:#FF69B4;color:#fff;padding:10px 20px;text-decoration:none;border-radius:5px;\">View Release</a></p>
              <hr>
              <p style=\"color:#666;\">Part of The Pink Revolution ðŸ’–</p>
            \`;
          } else if (eventName === 'discussion') {
            const discussionTitle = '${{ github.event.discussion.title }}';
            const discussionUrl = '${{ github.event.discussion.html_url }}';
            
            subject = \`ðŸ’¬ New Discussion: \${discussionTitle}\`;
            message = \`
              <h2>New Discussion in \${repo}</h2>
              <p><strong>Discussion:</strong> \${discussionTitle}</p>
              <p><strong>By:</strong> \${actor}</p>
              <p><a href=\"\${discussionUrl}\" style=\"background:#FF69B4;color:#fff;padding:10px 20px;text-decoration:none;border-radius:5px;\">View Discussion</a></p>
              <hr>
              <p style=\"color:#666;\">Part of The Pink Revolution ðŸ’–</p>
            \`;
          } else if (eventName === 'push') {
            const commitMessage = '${{ github.event.head_commit.message }}';
            const commitUrl = '${{ github.event.head_commit.url }}';
            const branch = '${{ github.ref_name }}';
            
            subject = \`ðŸ’– New Commit to \${branch}: \${commitMessage}\`;
            message = `
  <h2>New Commit to ${repo}</h2>
  <p><strong>Branch:</strong> ${branch}</p>
  <p><strong>Commit:</strong> ${commitMessage}</p>
  <p><strong>By:</strong> ${actor}</p>
  <p><a href="${commitUrl}" style="background:#FF69B4;color:#fff;padding:10px 20px;text-decoration:none;">View Commit</a></p>
  <hr>
  <p style="color:#666;">Part of The Pink Revolution ðŸ’–</p>
`;
          }

          const mailOptions = {
            from: process.env.EMAIL_USER,
            to: process.env.RECIPIENT_EMAIL,
            subject: subject,
            html: message
          };

          transporter.sendMail(mailOptions, (error, info) => {
            if (error) {
              console.log('Error:', error);
              process.exit(1);
            } else {
              console.log('Email sent:', info.response);
            }
          });
          "
