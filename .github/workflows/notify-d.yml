name: ğŸŸ£ Operation Purple - Notify via GitHub

on:
  push:
    branches: [main, master]
  issues:
    types: [opened, closed, reopened, assigned]
  pull_request:
    types: [opened, closed, reopened, review_requested]
  release:
    types: [published]
  discussion:
    types: [created, answered]

jobs:
  notify:
    name: ğŸŸ£ Post to Operation Purple Security
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸŸ£ Create notification issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const repo = context.repo.repo;
            const owner = context.repo.owner;
            const eventName = context.eventName;
            const actor = context.actor;
            const ref = context.ref;
            
            // Get commit info if this is a push event
            let title = '';
            let body = '';
            let labels = ['notification', 'operation-purple'];
            
            if (eventName === 'push') {
              const commitMessage = context.payload.head_commit?.message || 'Unknown commit';
              const commitUrl = context.payload.head_commit?.url || '';
              const commitSha = context.sha.substring(0, 7);
              const branch = ref.replace('refs/heads/', '');
              
              title = `ğŸ”„ Push to ${repo}: ${commitMessage.split('\n')[0]}`;
              body = `
            ## ğŸŸ£ Push Notification
            
            **Repository:** \`${owner}/${repo}\`  
            **Branch:** \`${branch}\`  
            **Commit:** [\`${commitSha}\`](${commitUrl})  
            **Author:** @${actor}
            
            ### ğŸ“ Commit Message:
            \`\`\`
            ${commitMessage}
            \`\`\`
            
            ### ğŸ”— Links:
            - [View Commit](${commitUrl})
            - [View Repository](https://github.com/${owner}/${repo})
            - [Actions](https://github.com/${owner}/${repo}/actions)
            
            ---
            ğŸŸ£ **Operation Purple** - Automated notification from philosopher-ai-backend
              `;
              labels.push('push');
              
            } else if (eventName === 'issues') {
              const issue = context.payload.issue;
              const action = context.payload.action;
              
              title = `ğŸ› Issue ${action}: ${issue.title}`;
              body = `
            ## ğŸŸ£ Issue ${action.charAt(0).toUpperCase() + action.slice(1)}
            
            **Repository:** \`${owner}/${repo}\`  
            **Issue #${issue.number}:** [${issue.title}](${issue.html_url})  
            **Action:** ${action}  
            **By:** @${actor}
            
            ### ğŸ“ Description:
            ${issue.body || '_No description provided_'}
            
            ### ğŸ”— Links:
            - [View Issue](${issue.html_url})
            - [View Repository](https://github.com/${owner}/${repo})
            
            ---
            ğŸŸ£ **Operation Purple** - Automated notification from philosopher-ai-backend
              `;
              labels.push('issue', action);
              
            } else if (eventName === 'pull_request') {
              const pr = context.payload.pull_request;
              const action = context.payload.action;
              
              title = `ğŸ”€ PR ${action}: ${pr.title}`;
              body = `
            ## ğŸŸ£ Pull Request ${action.charAt(0).toUpperCase() + action.slice(1)}
            
            **Repository:** \`${owner}/${repo}\`  
            **PR #${pr.number}:** [${pr.title}](${pr.html_url})  
            **Action:** ${action}  
            **By:** @${actor}  
            **From:** \`${pr.head.ref}\` â†’ \`${pr.base.ref}\`
            
            ### ğŸ“ Description:
            ${pr.body || '_No description provided_'}
            
            ### ğŸ”— Links:
            - [View Pull Request](${pr.html_url})
            - [View Repository](https://github.com/${owner}/${repo})
            
            ---
            ğŸŸ£ **Operation Purple** - Automated notification from philosopher-ai-backend
              `;
              labels.push('pull-request', action);
              
            } else if (eventName === 'release') {
              const release = context.payload.release;
              
              title = `ğŸš€ Release published: ${release.name || release.tag_name}`;
              body = `
            ## ğŸŸ£ Release Published
            
            **Repository:** \`${owner}/${repo}\`  
            **Release:** [${release.name || release.tag_name}](${release.html_url})  
            **Tag:** \`${release.tag_name}\`  
            **By:** @${actor}
            
            ### ğŸ“ Release Notes:
            ${release.body || '_No release notes provided_'}
            
            ### ğŸ”— Links:
            - [View Release](${release.html_url})
            - [Download Assets](${release.html_url})
            - [View Repository](https://github.com/${owner}/${repo})
            
            ---
            ğŸŸ£ **Operation Purple** - Automated notification from philosopher-ai-backend
              `;
              labels.push('release');
              
            } else if (eventName === 'discussion') {
              const discussion = context.payload.discussion;
              const action = context.payload.action;
              
              title = `ğŸ’¬ Discussion ${action}: ${discussion.title}`;
              body = `
            ## ğŸŸ£ Discussion ${action.charAt(0).toUpperCase() + action.slice(1)}
            
            **Repository:** \`${owner}/${repo}\`  
            **Discussion:** [${discussion.title}](${discussion.html_url})  
            **Action:** ${action}  
            **By:** @${actor}
            
            ### ğŸ“ Content:
            ${discussion.body || '_No content provided_'}
            
            ### ğŸ”— Links:
            - [View Discussion](${discussion.html_url})
            - [View Repository](https://github.com/${owner}/${repo})
            
            ---
            ğŸŸ£ **Operation Purple** - Automated notification from philosopher-ai-backend
              `;
              labels.push('discussion', action);
            }
            
            // Create the issue in operation-purple-security repo
            try {
              const result = await github.rest.issues.create({
                owner: 'overkor-tek',
                repo: 'operation-purple-security',
                title: title,
                body: body,
                labels: labels
              });
              
              console.log(`âœ… Notification created: ${result.data.html_url}`);
            } catch (error) {
              console.error('âŒ Failed to create notification:', error.message);
              core.setFailed(error.message);
            }
      
      - name: ğŸŸ£ Report success
        if: success()
        run: |
          echo "ğŸŸ£ Operation Purple notification posted successfully!"
          echo "ğŸ“Š Event: ${{ github.event_name }}"
          echo "ğŸ‘¤ Actor: ${{ github.actor }}"
          echo "ğŸ“¦ Repository: ${{ github.repository }}"
