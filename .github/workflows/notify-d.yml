name: ğŸŸ£ Operation Purple - Notify via GitHub

on:
  push:
    branches: [main, master]

jobs:
  notify:
    name: ğŸŸ£ Post to Operation Purple Security
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸŸ£ Create notification issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const repo = context.repo.repo;
            const owner = context.repo.owner;
            const eventName = context.eventName;
            const actor = context.actor;
            const ref = context.ref;
            
            let title = '';
            let body = '';
            const labels = ['notification', 'operation-purple'];
            
            if (eventName === 'push') {
              const commitMessage = context.payload.head_commit?.message || 'Unknown commit';
              const commitUrl = context.payload.head_commit?.url || '';
              const commitSha = context.sha.substring(0, 7);
              const branch = ref.replace('refs/heads/', '');
              
              title = `ğŸ”„ Push to ${repo}: ${commitMessage.split('\n')[0]}`;
              body = `## ğŸŸ£ Push Notification

**Repository:** \`${owner}/${repo}\`
**Branch:** \`${branch}\`
**Commit:** [\`${commitSha}\`](${commitUrl})
**Author:** @${actor}

### ğŸ“ Commit Message:
\`\`\`
${commitMessage}
\`\`\`

### ğŸ”— Links:
- [View Commit](${commitUrl})
- [View Repository](https://github.com/${owner}/${repo})
- [Actions](https://github.com/${owner}/${repo}/actions)

---
ğŸŸ£ **Operation Purple** - Automated notification from ${repo}`;
              
              labels.push('push');
            }
            
            try {
              const result = await github.rest.issues.create({
                owner: 'overkor-tek',
                repo: 'operation-purple-security',
                title: title,
                body: body,
                labels: labels
              });
              
              console.log(`âœ… Notification created: ${result.data.html_url}`);
            } catch (error) {
              console.error('âŒ Failed to create notification:', error.message);
              core.setFailed(error.message);
            }
      
      - name: ğŸŸ£ Report success
        if: success()
        run: |
          echo "ğŸŸ£ Operation Purple notification posted successfully!"
          echo "ğŸ“Š Event: ${{ github.event_name }}"
          echo "ğŸ‘¤ Actor: ${{ github.actor }}"
          echo "ğŸ“¦ Repository: ${{ github.repository }}"
